<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>TapoBotX — Mining</title>
<style>
:root{--accent:#00eaff;--text:#002b5c;}
html,body{height:100%;margin:0;padding:0;overflow:hidden;font-family:Inter,sans-serif;}
body{background:url('./IMG_20251011_155158_294.jpg') no-repeat center/cover;display:flex;align-items:center;justify-content:center;position:relative;}
.overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.02));z-index:0;}
.app{position:relative;z-index:3;width:100%;max-width:720px;padding:18px;display:flex;flex-direction:column;align-items:center;gap:12px;}
.topbar{width:100%;display:flex;justify-content:space-between;align-items:center;padding:6px 4px;}
.coin-small{display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.25);padding:6px 10px;border-radius:14px;backdrop-filter:blur(4px);}
.coin-icon{width:36px;height:36px;background:url('./1000066477-removebg-preview.png') center/contain no-repeat;border-radius:50%;box-shadow:0 6px 18px rgba(0,0,0,0.18);animation:spinSlow 6s linear infinite;}
@keyframes spinSlow{0%{transform:rotate(0);}100%{transform:rotate(360deg);}}
.balance-text{font-weight:700;font-size:16px;color:#001f3f;}
.small-unclaimed{font-size:12px;color:#034;opacity:0.95;}
.wallet-small{display:flex;align-items:center;gap:4px;background:transparent;color:#001f3f;font-size:13px;padding:6px 8px;border-radius:10px;}
.mine-center{margin-top:6px;width:86%;max-width:420px;background:rgba(255,255,255,0.0);border-radius:18px;padding:18px;display:flex;flex-direction:column;align-items:center;gap:10px;}
.mining-circle{width:220px;height:220px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at 30% 30%, rgba(255,255,255,0.04), rgba(255,255,255,0.00) 60%);box-shadow:inset 0 -8px 30px rgba(0,0,0,0.12);position:relative;}
.mining-icon{width:120px;height:120px;background:url('./1000066477-removebg-preview.png') center/contain no-repeat;z-index:2;}
.tap-btn{position:absolute;bottom:10px;width:92px;height:92px;border-radius:999px;border:none;background:linear-gradient(180deg,var(--accent),#00ffcc);display:flex;align-items:center;justify-content:center;color:#001;font-weight:700;font-size:18px;cursor:pointer;box-shadow:0 12px 36px rgba(0,230,255,0.18);z-index:3;}
.tap-btn:active{transform:scale(0.98);}
.collect-small{position:absolute;left:12px;top:12px;background:rgba(255,255,255,0.9);padding:8px 10px;border-radius:8px;font-weight:600;font-size:13px;color:#003;box-shadow:0 6px 18px rgba(0,0,0,0.12);opacity:0.5;pointer-events:none;z-index:4;}
.energy-bar{width:80%;height:10px;background:rgba(0,0,0,0.06);border-radius:10px;overflow:hidden;}
.energy-fill{height:100%;background:linear-gradient(90deg,#ffd6a5,#ffd54a);width:100%;transition:width .25s linear;}
.bottom-menu{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);width:calc(100% - 40px);max-width:720px;display:flex;justify-content:space-around;gap:8px;z-index:6;pointer-events:auto;background: rgba(255,255,255,0.0);padding:8px 12px;}
.menu-btn{display:flex;flex-direction:column;align-items:center;gap:6px;background:transparent;border:none;color:#001;cursor:pointer;width:64px;height:64px;border-radius:14px;}
.menu-btn img{width:28px;height:28px;opacity:0.95;filter: drop-shadow(0 4px 8px rgba(0,0,0,0.12));}
.tap-coin{position:absolute;width:36px;height:36px;background:url('./1000066477-removebg-preview.png') center/contain no-repeat;z-index:40;animation:riseAndFade 4s forwards;pointer-events:none;}
@keyframes riseAndFade{0%{transform: translateY(0) scale(0.6);opacity:1;}40%{transform:translateY(-60px) scale(0.9);opacity:1;}100%{transform:translateY(-160px) scale(1.2);opacity:0;}}
</style>
</head>
<body>
<div class="overlay"></div>
<div class="app">
  <div class="topbar">
    <div style="display:flex;align-items:center;gap:10px;">
      <div class="coin-small"><div class="coin-icon"></div></div>
      <div style="display:flex;flex-direction:column;">
        <div class="balance-text" id="balanceText">0.00000000 TPBX</div>
        <div class="small-unclaimed" id="smallUnclaimed">Unclaimed: 0.00000000</div>
      </div>
    </div>
    <div class="wallet-small">
      <img src="./1000066477-removebg-preview.png" alt="wallet" style="width:18px;"> Coming soon
    </div>
  </div>
  <div class="mine-center">
    <div class="mining-circle" id="miningCircle">
      <div class="collect-small" id="collectBtn">Collect 1 TPBX</div>
      <div class="mining-icon"></div>
      <button id="tapBtn" class="tap-btn">⚡ TAP</button>
    </div>
    <div style="width:100%;display:flex;flex-direction:column;align-items:center;gap:6px;margin-top:8px;">
      <div class="energy-bar"><div id="energyFill" class="energy-fill"></div></div>
      <div style="font-size:12px;color:#012;opacity:0.9">Each tap: <strong>0.00000001 TPBX</strong></div>
    </div>
  </div>
</div>
<div class="bottom-menu">
  <button class="menu-btn" id="minersBtn"><img src="https://cdn-icons-png.flaticon.com/512/833/833314.png"><div style="font-size:11px">Miners</div></button>
  <button class="menu-btn" id="refsBtn"><img src="https://cdn-icons-png.flaticon.com/512/565/565547.png"><div style="font-size:11px">Referrals</div></button>
  <button class="menu-btn" id="tasksBtn"><img src="https://cdn-icons-png.flaticon.com/512/1250/1250615.png"><div style="font-size:11px">Tasks</div></button>
  <button class="menu-btn" id="profileBtn"><img src="https://cdn-icons-png.flaticon.com/512/747/747376.png"><div style="font-size:11px">Profile</div></button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
import { getDatabase, ref, set, update, onValue, get, child } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-database.js";

// CONFIG FIREBASE
const firebaseConfig = {
  apiKey:"AIzaSyDoNAVJdjlDr6qSj1r8-J1c4F6_k6BDqGw",
  authDomain:"tapobox-34214.firebaseapp.com",
  projectId:"tapobox-34214",
  storageBucket:"tapobox-34214.firebasestorage.app",
  messagingSenderId:"905512443769",
  appId:"1:905512443769:web:4d3ffdeca37a3c591659a8"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

// URL params
const params = new URLSearchParams(window.location.search);
const tg_id = params.get('tg_id') || ('guest_' + Math.floor(Math.random()*900000+100000));
const tg_name = params.get('tg_name') || ('Guest_' + tg_id);
const userPath = 'users/'+tg_id;

// Unique code
function genUniqueID(){return Math.random().toString(36).substring(2,6).toUpperCase();}
let userCode = genUniqueID();

// State
let state={id:tg_id,name:tg_name,total_balance:0,unclaimed:0,energy:100,canTap:true};

// UI
const balanceText=document.getElementById('balanceText');
const smallUnclaimed=document.getElementById('smallUnclaimed');
const energyFill=document.getElementById('energyFill');
const tapBtn=document.getElementById('tapBtn');
const collectBtn=document.getElementById('collectBtn');
const miningCircle=document.getElementById('miningCircle');

// INIT USER AND AUTO REGISTER
async function initUser(){
  try{
    const snap = await get(child(ref(db),userPath));
    if(!snap.exists()){
      await set(ref(db,userPath),{
        id:state.id,
        name:state.name,
        userCode:userCode,
        total_balance:0,
        unclaimed:0,
        energy:100,
        joinedAt:new Date().toISOString()
      });
      console.log("Nuevo usuario registrado en Firebase");
    }else{
      const u = snap.val();
      state.total_balance = Number(u.total_balance||0);
      state.unclaimed = Number(u.unclaimed||0);
      state.energy = Number(u.energy||100);
    }
    onValue(ref(db,userPath),snap=>{
      if(!snap.exists())return;
      const val = snap.val();
      state.total_balance=Number(val.total_balance||0);
      state.unclaimed=Number(val.unclaimed||0);
      state.energy=Number(val.energy||100);
      render();
    });
  }catch(e){console.error(e);}
}

// RENDER
function render(){
  balanceText.textContent = state.total_balance.toFixed(8)+" TPBX";
  smallUnclaimed.textContent = "Unclaimed: "+state.unclaimed.toFixed(8);
  energyFill.style.width = state.energy+"%";
  tapBtn.disabled = !state.canTap || state.energy<=0;
  collectBtn.style.opacity = (state.unclaimed>=1?1:0.45);
  collectBtn.style.pointerEvents = (state.unclaimed>=1?'auto':'none');
}

// TAP
const TAP_AMOUNT=0.00000001;
tapBtn.addEventListener('click',()=>{
  if(!state.canTap||state.energy<=0)return;
  state.unclaimed+=TAP_AMOUNT;
  state.energy=Math.max(0,state.energy-0.2);
  render(); spawnTapCoin();
  update(ref(db,userPath),{unclaimed:state.unclaimed,energy:state.energy});
});

// SPAWN COIN
function spawnTapCoin(){
  const coin=document.createElement('div');
  coin.className='tap-coin';
  const rect=miningCircle.getBoundingClientRect();
  coin.style.left=(rect.left+rect.width/2-18)+'px';
  coin.style.top=(rect.top+rect.height/2-18)+'px';
  document.body.appendChild(coin);
  setTimeout(()=>coin.remove(),4200);
}

// COLLECT
collectBtn.addEventListener('click',async()=>{
  if(state.unclaimed<1)return;
  state.unclaimed-=1; state.total_balance+=1;
  await update(ref(db,userPath),{total_balance:state.total_balance,unclaimed:state.unclaimed});
  render(); alert("Collected 1 TPBX!");
});

// NAV
document.getElementById('profileBtn').addEventListener('click',()=>{window.location.href=`perfil.html?tg_id=${state.id}&tg_name=${state.name}&userCode=${userCode}`;});
document.getElementById('minersBtn').addEventListener('click',()=>{alert("Miners page coming soon");});
document.getElementById('refsBtn').addEventListener('click',()=>{alert("Referrals page coming soon");});
document.getElementById('tasksBtn').addEventListener('click',()=>{alert("Tasks page coming soon");});

// START
initUser();
</script>
</body>
</html>
