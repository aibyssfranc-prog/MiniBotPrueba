<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<title>TapoBotX â€” Mining</title>
<style>
:root{--accent:#00eaff;--text:#ffffff;}
html,body{height:100%;margin:0;padding:0;overflow:hidden;font-family:Inter,sans-serif;background:#001f3f;}
.overlay{position:absolute;inset:0;background:linear-gradient(180deg,rgba(0,0,0,0.2),rgba(0,0,0,0.4));z-index:0;}
.app{position:relative;z-index:3;width:100%;max-width:720px;padding:18px;display:flex;flex-direction:column;align-items:center;gap:12px;}
.topbar{width:100%;display:flex;justify-content:space-between;align-items:center;padding:6px 4px;}
.balance-text{font-weight:700;font-size:16px;color:var(--text);text-shadow:0 0 6px #000;}
.small-unclaimed{font-size:12px;color:var(--text);opacity:0.9;text-shadow:0 0 4px #000;}
.wallet-small{display:flex;align-items:center;gap:4px;color:var(--text);font-size:13px;padding:6px 8px;border-radius:10px;text-shadow:0 0 4px #000;}
.mine-center{margin-top:6px;width:86%;max-width:420px;display:flex;flex-direction:column;align-items:center;gap:10px;}
.mining-circle{width:220px;height:220px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.05);position:relative;}
.tap-btn{width:120px;height:120px;border-radius:999px;border:none;background:linear-gradient(180deg,#00eaff,#00ffcc);display:flex;align-items:center;justify-content:center;gap:8px;color:#001;font-weight:700;font-size:24px;cursor:pointer;box-shadow:0 12px 36px rgba(0,230,255,0.18);position:relative;z-index:2;}
.tap-btn img{width:48px;height:48px;}
.collect-small{position:absolute;left:12px;top:12px;background:rgba(255,255,255,0.9);padding:8px 10px;border-radius:8px;font-weight:600;font-size:13px;color:#003;box-shadow:0 6px 18px rgba(0,0,0,0.12);opacity:0.5;pointer-events:none;z-index:4;}
.energy-bar{width:80%;height:10px;background:rgba(255,255,255,0.1);border-radius:10px;overflow:hidden;}
.energy-fill{height:100%;background:linear-gradient(90deg,#ffd6a5,#ffd54a);width:100%;transition:width .25s linear;}
.bottom-menu{position:fixed;bottom:10px;left:50%;transform:translateX(-50%);width:calc(100% - 40px);max-width:720px;display:flex;justify-content:space-around;gap:8px;z-index:6;pointer-events:auto;background: rgba(0,0,0,0.6);padding:8px 12px;border-radius:14px;box-shadow:0 4px 12px rgba(0,0,0,0.5);}
.menu-btn{display:flex;flex-direction:column;align-items:center;gap:4px;background:rgba(255,255,255,0.1);border:none;color:var(--text);cursor:pointer;width:64px;height:64px;border-radius:14px;text-shadow:0 0 4px #000;box-shadow:0 4px 12px rgba(0,0,0,0.4);}
.menu-btn img{width:28px;height:28px;}
.tap-coin{position:absolute;width:36px;height:36px;background:url('./1000066477-removebg-preview.png') center/contain no-repeat;z-index:40;animation:riseAndFade 4s forwards;pointer-events:none;}
@keyframes riseAndFade{0%{transform: translateY(0) scale(0.6);opacity:1;}40%{transform:translateY(-60px) scale(0.9);opacity:1;}100%{transform:translateY(-160px) scale(1.2);opacity:0;}}
</style>
</head>
<body>
<div class="overlay"></div>
<div class="app">
  <div class="topbar">
    <div style="display:flex;flex-direction:column;">
      <div class="balance-text" id="balanceText">0.00000000 TPBX</div>
      <div class="small-unclaimed" id="smallUnclaimed">Unclaimed: 0.00000000</div>
    </div>
    <div class="wallet-small">
      <img src="./1000066477-removebg-preview.png" alt="wallet"> Coming soon
    </div>
  </div>
  <div class="mine-center">
    <div class="mining-circle" id="miningCircle">
      <div class="collect-small" id="collectBtn">Collect 1 TPBX</div>
      <button id="tapBtn" class="tap-btn">
        <img src="./1000066477-removebg-preview.png" alt="TPBX">
        TAP
      </button>
    </div>
    <div style="width:100%;display:flex;flex-direction:column;align-items:center;gap:6px;margin-top:8px;">
      <div class="energy-bar"><div id="energyFill" class="energy-fill"></div></div>
      <div style="font-size:12px;color:#fff;text-shadow:0 0 4px #000;">Each tap: <strong>0.00000001 TPBX</strong></div>
    </div>
  </div>
</div>
<div class="bottom-menu">
  <button class="menu-btn" id="minersBtn"><img src="https://cdn-icons-png.flaticon.com/512/833/833314.png"><div style="font-size:11px">Miners</div></button>
  <button class="menu-btn" id="refsBtn"><img src="https://cdn-icons-png.flaticon.com/512/565/565547.png"><div style="font-size:11px">Referrals</div></button>
  <button class="menu-btn" id="tasksBtn"><img src="https://cdn-icons-png.flaticon.com/512/1250/1250615.png"><div style="font-size:11px">Tasks</div></button>
  <button class="menu-btn" id="profileBtn"><img src="https://cdn-icons-png.flaticon.com/512/747/747376.png"><div style="font-size:11px">Profile</div></button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-app.js";
import { getDatabase, ref, set, update, onValue, get, child } from "https://www.gstatic.com/firebasejs/11.9.0/firebase-database.js";

const firebaseConfig = {
    apiKey:"AIzaSyDoNAVJdjlDr6qSj1r8-J1c4F6_k6BDqGw",
    authDomain:"tapobox-34214.firebaseapp.com",
    projectId:"tapobox-34214",
    storageBucket:"tapobox-34214.firebasestorage.app",
    messagingSenderId:"905512443769",
    appId:"1:905512443769:web:4d3ffdeca37a3c591659a8"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

const params = new URLSearchParams(window.location.search);
const tg_id = params.get('tg_id') || ('guest_' + Math.floor(Math.random()*900000+100000));
const tg_name = params.get('tg_name') || ('Guest_' + tg_id);
const userPath = 'users/' + tg_id;

function genUniqueID(){ return Math.random().toString(36).substring(2,6).toUpperCase(); }
let userCode = genUniqueID();

let state = { id: tg_id, name: tg_name, total_balance: 0, unclaimed: 0, energy: 100, canTap: true };

const balanceText = document.getElementById('balanceText');
const smallUnclaimed = document.getElementById('smallUnclaimed');
const energyFill = document.getElementById('energyFill');
const tapBtn = document.getElementById('tapBtn');
const collectBtn = document.getElementById('collectBtn');
const miningCircle = document.getElementById('miningCircle');

async function initUser() {
    try {
        const snap = await get(child(ref(db), userPath));
        if(!snap.exists()) {
            await set(ref(db, userPath), {
                id: state.id,
                name: state.name,
                userCode: userCode,
                total_balance: 0,
                unclaimed: 0,
                energy: 100,
                joinedAt: new Date().toISOString()
            });
        } else {
            const u = snap.val();
            state.total_balance = Number(u.total_balance || 0);
            state.unclaimed = Number(u.unclaimed || 0);
            state.energy = Number(u.energy || 100);
        }
        onValue(ref(db, userPath), snap => {
            if(!snap.exists()) return;
            const val = snap.val();
            state.total_balance = Number(val.total_balance || 0);
            state.unclaimed = Number(val.unclaimed || 0);
            state.energy = Number(val.energy || 100);
            render();
        });
    } catch(e) { console.error(e); }
}

function render() {
    balanceText.textContent = state.total_balance.toFixed(8) + " TPBX";
    smallUnclaimed.textContent = "Unclaimed: " + state.unclaimed.toFixed(8);
    energyFill.style.width = state.energy + "%";
    tapBtn.disabled = !state.canTap || state.energy <= 0;
    collectBtn.style.opacity = (state.unclaimed >= 1 ? 1 : 0.45);
    collectBtn.style.pointerEvents = (state.unclaimed >= 1 ? 'auto' : 'none');
}

const TAP_AMOUNT = 0.00000001;
tapBtn.addEventListener('click', () => {
    if(!state.canTap || state.energy <= 0) return;
    state.unclaimed += TAP_AMOUNT;
    state.energy = Math.max(0, state.energy - 0.2);
    render();
    spawnTapCoin();
    update(ref(db, userPath), { unclaimed: state.unclaimed, energy: state.energy });
});

function spawnTapCoin() {
    const coin = document.createElement('div');
    coin.className = 'tap-coin';
    const rect = miningCircle.getBoundingClientRect();
    coin.style.left = (rect.left + rect.width / 2 - 18) + 'px';
    coin.style.top = (rect.top + rect.height / 2 - 18) + 'px';
    document.body.appendChild(coin);
    setTimeout(() => coin.remove(), 4200);
}

collectBtn.addEventListener('click', async () => {
    if(state.unclaimed < 1) return;
    state.unclaimed -= 1;
    state.total_balance += 1;
    await update(ref(db, userPath), { total_balance: state.total_balance, unclaimed: state.unclaimed });
    render();
    alert("Collected 1 TPBX!");
});

document.getElementById('profileBtn').addEventListener('click', () => { window.location.href = `perfil.html?tg_id=${state.id}&tg_name=${state.name}&userCode=${userCode}`; });
document.getElementById('minersBtn').addEventListener('click', () => { alert("Miners page coming soon"); });
document.getElementById('refsBtn').addEventListener('click', () => { alert("Referrals page coming soon"); });
document.getElementById('tasksBtn').addEventListener('click', () => { alert("Tasks page coming soon"); });

initUser();
</script>
</body>
</html>
